image:
  name: ubuntu-20.04-desktop
  distribution: ubuntu
  release: focal
  description: |-
    Ubuntu 20.04 Desktop with Applications
  architecture: x86_64

source:
  downloader: rootfs-http

mappings:
  architecture_map: debian

packages:
  manager: apt
  update: true
  cleanup: true

files:
- path: /etc/hostname
  generator: hostname

- path: /etc/hosts
  generator: hosts

- path: /etc/resolvconf/resolv.conf.d/original
  generator: remove

- path: /etc/resolvconf/resolv.conf.d/tail
  generator: remove

- path: /etc/machine-id
  generator: dump

- path: /var/lib/dbus/machine-id
  generator: remove

- path: /etc/netplan/10-lxc.yaml
  generator: dump
  mode: 0600
  content: |-
    network:
      version: 2
      ethernets:
        eth0:
          dhcp4: true
          dhcp-identifier: mac

- path: /etc/network/interfaces
  generator: dump
  content: |-
    # This file describes the network interfaces available on your system
    # and how to activate them. For more information, see interfaces(5).

    # The loopback network interface
    auto lo
    iface lo inet loopback

    auto eth0
    iface eth0 inet dhcp

    source /etc/network/interfaces.d/*.cfg

- path: /etc/sudoers.d/90-incus
  generator: dump
  mode: 0440
  content: |-
    # User rules for ubuntu
    ubuntu ALL=(ALL) NOPASSWD:ALL

# Fixes “Authentication Is Required To Create A Color Profile/Managed Device”
- path: /etc/polkit-1/localauthority/50-local.d/45-allow-colord.pkla
  generator: dump
  content: |-
    [Allow Colord all Users]
    Identity=unix-user:*
    Action=org.freedesktop.color-manager.create-device;org.freedesktop.color-manager.create-profile;org.freedesktop.color-manager.delete-device;org.freedesktop.color-manager.delete-profile;org.freedesktop.color-manager.modify-device;org.freedesktop.color-manager.modify-profile
    ResultAny=no
    ResultInactive=no
    ResultActive=yes

- path: /home/user1/.config/dconf/
  generator: copy
  source: ./dconf/user
  mode: 664
  uid: 1001
  gid: 1001

actions:
- trigger: post-update
  action: |-
    #!/bin/sh
    set -eux

    # Create the ubuntu user account
    getent group sudo >/dev/null 2>&1 || groupadd --system sudo
    useradd --create-home -s /bin/bash -G sudo -U ubuntu

- trigger: post-update
  # Adds a user
  action: |-
    #!/bin/sh
    set -eux

    # Create the first user account
    useradd -p '$6$EioZtEpQ//S3Fvyg$FROs9q9mkrzQAg43olkR.KXVfFeEtzpSl3W/wrE.0tL.hxKHc2TXfqq/YtsN1Z2hNKZ86T5gXaxX51eXJnQlS.' \
      --create-home -s /bin/bash -U user1

- trigger: post-packages
  action: |-
    #!/bin/sh
    set -eux

    mkdir -p /home/user1/.local/share/applications/
    sed 's|^Exec=/usr/bin/google-chrome-stable|\0 --password-store=basic|g' \
      /usr/share/applications/google-chrome.desktop > /home/user1/.local/share/applications/google-chrome.desktop

    # Skips the welcome page for Google Chrome.
    mkdir -p /home/user1/.config/google-chrome
    touch /home/user1/.config/google-chrome/'First Run'

- trigger: post-packages
  action: |-
    #!/bin/sh
    set -eux

    # Enable systemd-networkd
    systemctl enable systemd-networkd

    # Disable UA attach
    systemctl mask ua-auto-attach

- trigger: post-packages
  action: |-
    #!/bin/sh
    set -eux

    # Make sure the locale is built and functional
    locale-gen en_US.UTF-8
    update-locale LANG=en_US.UTF-8

    # Cleanup underlying /run
    mount -o bind / /mnt
    rm -rf /mnt/run/*
    umount /mnt

    # Cleanup temporary shadow paths
    rm /etc/*-

- trigger: post-files
  action: |-
    #!/bin/sh
    set -eux

    chown -R user1:user1 /home/user1
