image:
  distribution: ubuntu
  release: focal

source:
  downloader: rootfs-http

targets: {}

mappings:
  architecture_map: debian

packages:
  manager: apt
  update: true
  cleanup: true
  sets:
  - packages:
    - curl
    - fuse
    - language-pack-en
    - openssh-client
    - sudo
    - vim
    - wget
    action: install
    flags: [--no-install-recommends]

  - packages:
    - cloud-init
    action: install
    flags: [--no-install-recommends]

files:
- path: /etc/cloud/cloud.cfg.d/95_datasource.cfg
  generator: copy
  source: ./files/etc/cloud/cloud.cfg.d/95_datasource.cfg

actions:
# Adds an initial user
- trigger: post-packages
  action: |-
    #!/bin/sh
    set -eux

    # Create the first user account
    useradd --create-home -s /bin/bash -U user1

- trigger: post-packages
  action: |-
    #!/bin/sh
    set -eux

    # Fixes a problem that prevents cloud-init.service from being started.
    sed '/^After=systemd-networkd-wait-online.service/d' /lib/systemd/system/cloud-init.service > /etc/systemd/system/cloud-init.service
